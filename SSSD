                [ SSSD: System Security Services Daemon ]

Reference: (Some of them need RedHat user account to access)
  1) https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html-single/integrating_rhel_systems_directly_with_windows_active_directory/index#connecting-rhel-systems-directly-to-ad-using-sssd_integrating-rhel-systems-directly-with-active-directory
  2) How to join RHEL to Active Directory using realmd ==>
      https://access.redhat.com/solutions/1350723
  3) SSSD service is failing with an error 'Failed to initialize credentials using keytab [MEMORY:/etc/krb5.keytab]: Preauthentication failed.' ==> 
      https://access.redhat.com/solutions/3380341
  4) Basic Prechecks Steps: RHEL Join With Active Directory using 'adcli', 'realm' and 'net' commands
      https://access.redhat.com/solutions/5444941
  5) Performance tuning
      https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html-single/tuning_performance_in_identity_management/index
      https://sssd.io/design-pages/one_fourteen_performance_improvements.html
  6) Troubleshooting
      https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/system-level_authentication_guide/trouble#SSSD-Troubleshooting
  7) Understanding SSSD and its benefits
      https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html/configuring_authentication_and_authorization_in_rhel/understanding-sssd-and-its-benefits_configuring-authentication-and-authorization-in-rhel


Prerequisite to join rhel client to AD:
  # dnf install adcli realmd sssd oddjob oddjob-mkhomedir samba-common-tools krb5-workstation authselect-compat

Pre Check:
Ref: https://access.redhat.com/solutions/5444941 (Need RedHat user account to access)
1. Ensure that the user you use to join with Active Directory has the following user permissions:

  - On the object types:  
     * Computer
  
  - Standard permissions required for joining all systems to an AD:
     * Reset password
     * Read account restrictions
     * Write account restrictions
     * Validated write to DNS host name
     * Validated write to service principal name
  
  - Additional permissions required for joining Linux systems to an AD:
     * Read DNS host name attributes
     * Write DNS host name attributes
     * Read DNSHostName
     * Write DNSHostName
     * Read msDS-AddtionalSamAccountName
     * Write msDS-AddtionalSamAccountName
     * Read msDS-SupportedEncryptionTypes
     * Write msDS-SupportedEncryptionTypes
     * Read Operating System
     * Write Operating System
     * Read Operating System Version
     * Write Operating System Version
     * Read OperatingSystemServicePack
     * Write OperatingSystemServicePack
     * Read servicePrincipalName
     * Write servicePrincipalName
     * Read userAccountControl
     * Write userAccountControl
     * Read userPrincipal Name
     * Write userPrincipal Name

2. DNS lookup of AD is resolving.
    # dig +short SRV _ldap._tcp.addomain.test
    # dig +short SRV _kerberos._tcp.addomain.test
    # dig +short SRV _kerberos._udp.addomain.test

3. Port reach ability from RHEL to Active Directory servers.
    Source port -    Destination -    Protocol      - Service
    1024:65535  -    53          -    TCP and UDP   - DNS
    1024:65535  -    389         -    TCP and UDP   - LDAP
    1024:65535  -    636         -    TCP           - LDAPS
    1024:65535  -    88          -    TCP and UDP   - Kerberos
    1024:65535  -    464         -    TCP and UDP   - Kerberos change/set password (kadmin)
    1024:65535  -    3268        -    TCP           - LDAP Global Catalog (If "id_provider = ad" is being used)
    1024:65535  -    3269        -    TCP           - LDAP Global Catalog SSL
    1024:65535  -    123         -    UDP           - NTP (Optional)

Validate if all ports listed are reachable to Active Directory servers which are part of AD domain.
Bash script to validate: https://github.com/mash-ops/myBASH/blob/master/ActiveDirectory_preCheck.bash

After above checks, steps to join the rhel client to AD (ActiveDirectory):
  # realm discover your.Domain
  # realm -v join --client-software=sssd your.Domain -U AD_account*
    *see Pre check to ensure the account has permission, -v is verbose
  # realm list ; getent passwd AD_User (this should return the AD user account details)
  # Adjust /etc/sssd/sssd.conf to your domain needs, if you modify, systemctl restart sssd

Caveat:
  1) Home directory being created with user@your.domain
     By Default in /etc/sssd/sssd.conf fallback_homedir = /home/%u@%d
     Resolution: fallback_homedir = /home/%u
       
  2) Sudo -s ==> slowness on RHEL 9 client joined to AD.
     Resolution: Add the following under [domain/your.Domain] section in /etc/sssd/sssd.conf
                ad_gpo_access_control = permissive
                ad_gpo_ignore_unreadable = True
                ignore_group_members = true
                subdomain_inherit = ignore_group_members
                dyndns_update = False

  3) [Pre-authentication failed: Cannot read password] filling up /var/log/sssd/krb5_child.log
     Ref: https://access.redhat.com/solutions/7059267
     Resolution: Add the following under [pam] section in /etc/sssd/sssd.conf
                 if [pam] does not exist add a section, and systemctl restart sssd
                  [pam]
                  pam_passkey_auth = False

  4) TSIG error with server: tsig verify failure messages in sssd logs
     Note: we are not using DHCP, hence turning it to false (Default is True)
     Resolution: Add the following under [domain/your.Domain] section in /etc/sssd/sssd.conf
                 dyndns_update = False

Debugging:
  1) dnf install sssd-tools (for command /usr/sbin/sssctl) 
     Version (2.9.4-6.el9_4.1) has following Available commands:
      
      SSSD Status:
      * domain-list            List available domains
      * domain-status          Print information about domain
      * user-checks            Print information about a user and check authentication
      * access-report          Generate access report for a domain
      
      Information about cached content:
      * user-show              Information about cached user
      * group-show             Information about cached group
      * netgroup-show          Information about cached netgroup
      
      Local data tools:
      * client-data-backup     Backup local data
      * client-data-restore    Restore local data from backup
      * cache-remove           Backup local data and remove cached content
      * cache-upgrade          Perform cache upgrade
      * cache-expire           Invalidate cached objects
      * cache-index            Manage cache indexes
      
      Log files tools:
      * logs-remove            Remove existing SSSD log files
      * logs-fetch             Archive SSSD log files in tarball
      * debug-level            Change or print information about SSSD debug level
      * analyze                Analyze logged data
      
      Configuration files tools:
      * config-check           Perform static analysis of SSSD configuration
      
      Certificate related tools:
      * cert-show              Print information about the certificate
      * cert-map               Show users mapped to the certificate
      * cert-eval-rule         Check mapping and matching rule with a certificate
      
      Passkey related tools:
      * passkey-register       Perform passkey registration
      
      Help options:
        -?, --help             Show this for a command
        --usage                Show brief usage message for a command
      
      Debug options:
        --debug                Enable debug log level of sssctl tool


adcli Tool : adcli is a tool for joining an Active Directory domain using
        standard LDAP and Kerberos calls.
    1) adcli -v info Your.Realm
    2) adcli show-computer hostname -D Your.Realm -U AD_Admin
    3) Common adcli commands are:
              info             Print information about a domain
              join             Join this machine to a domain
              update           Update machine membership in a domain
              testjoin         Test if machine account password is valid
              preset-computer  Pre setup computers accounts
              reset-computer   Reset a computer account
              delete-computer  Delete a computer account
              show-computer    Show computer account attributes stored in AD
              create-msa       Create a managed service account in the given AD domain
              create-user      Create a user account
              delete-user      Delete a user account
              passwd-user      (Re)set a user password
              create-group     Create a group
              delete-group     Delete a group
              add-member       Add users to a group
              remove-member    Remove users from a group

Realmd Package:
  Summary     : Kerberos realm enrollment service
  Description :
    realmd is a DBus system service which manages discovery and enrollment in realms
    and domains like Active Directory or IPA. The control center uses realmd as the
    back end to 'join' a domain simply and automatically configure things correctly.
  1) realm list
  2) Realm commands
         realm discover -v [realm-name]
           Discover available realm
         realm join -v [-U user] realm-name
           Enroll this machine in a realm
         realm leave -v [-U user] [realm-name]
           Unenroll this machine from a realm
         realm list
           List known realms
         realm permit [-ax] [-R realm] user ...
           Permit user logins
         realm deny --all [-R realm]
           Deny user logins
